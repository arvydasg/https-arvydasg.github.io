<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="description" content="A guide to deploying a flask application.">
<link rel="alternate"
      type="application/rss+xml"
      href="https://arvydasg.github.io/rss.xml"
      title="RSS feed for https://arvydasg.github.io/">
<title>Deploying Flask Application on Ubuntu VPS using Nginx</title>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MC4ZQHP');</script>
<!-- End Google Tag Manager -->
<meta name="author" content="Arvydas Gasparavicius">
<meta name="referrer" content="no-referrer">
<meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1">
<link href= "static/style.css" rel="stylesheet" type="text/css" />
<script src="static/lightbox.js"></script>
<script src="static/auto-render.min.js"></script>
<link rel="icon" href="static/ag.ico"></head>
<body>
<div id="preamble" class="status">
<header>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MC4ZQHP"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
    <div class="container">
        <div class="subcontainer">
            <nav class="nav">
                <a href="https://arvydasg.github.io/" class="nav-logo-wrapper">
                    <p class="nav-branding">Arvydas.dev</p>
                </a>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="https://arvydasg.github.io/tag-project.html" class="nav-link">Projects</a>
                    </li>
                    <li class="nav-item">
                        <a href="https://arvydasg.github.io/archive.html" class="nav-link">Blog</a>
                    </li>
                    <li class="nav-item">
                        <a href="https://arvydasg.github.io/tags.html" class="nav-link">Tags</a>
                    </li>
                    <li class="nav-item">
                        <a href="https://arvydas.dev/codeacademy/" class="nav-link">CodeAcademy</a>
                    </li>
                    <li class="nav-item">
                        <a href="https://arvydasg.github.io/freelancing.html" class="nav-link">Freelancing</a>
                    </li>
                    <li class="nav-item">
                        <a href="https://arvydasg.github.io/uses.html" class="nav-link">Uses</a>
                    </li>
                    <li class="nav-item">
                        <a href="https://arvydasg.github.io/about.html" class="nav-link">About</a>
                    </li>
                </ul>
                <div class="hamburger">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </nav>
        </div>
    </div>
    </header>
    </div>
<div id="content">
<div class="post-date">03 Mar 2023</div><h1 class="post-title"><a href="https://arvydasg.github.io/2023-03-03-deploying-flask-application-on-ubuntu-vps-using-nginx.html">Deploying Flask Application on Ubuntu VPS using Nginx</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgd0a4afb">1. Apache vs nginx</a></li>
<li><a href="#org7948fef">2. Get yourself a virtual private server(VPS)</a></li>
<li><a href="#orgde76f1c">3. Install nginx</a></li>
<li><a href="#orgcbd4947">4. Let's run project</a></li>
<li><a href="#org1fa1c9e">5. Gunicorn</a></li>
<li><a href="#orgf5334c7">6. Dealing with secret files</a></li>
</ul>
</div>
</nav>
<p>
In my free time between my work, my python course, dev job search,
etc, I was building a flask application for quotes that I have
gathered during the years. I wanted this project to be finished, to be
live. For that I need to host it.
</p>

<p>
Will share with you how I did it.
</p>

<div id="outline-container-orgd0a4afb" class="outline-2">
<h2 id="orgd0a4afb"><span class="section-number-2">1.</span> Apache vs nginx</h2>
<div class="outline-text-2" id="text-1">
<p>
Will just leave it here.
</p>

<blockquote>
<p>
Also, one thing I would like you to know is that Apache is a threaded
server, which means it is prone to <a href="https://www.cloudflare.com/learning/ddos/what-is-a-ddos-attack/#:~:text=Insights-,What%20is%20a%20DDoS%20attack%3F,a%20flood%20of%20Internet%20traffic.">DDOS</a> and DOS attacks. But Nginx on
the other hand is an asynchronous web server and <a href="https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy/#:~:text=A%20reverse%20proxy%20is%20a,security%2C%20performance%2C%20and%20reliability.">reverse proxy</a>, so it
is not as vulnerable as Apache, and it is also very easy to set up.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org7948fef" class="outline-2">
<h2 id="org7948fef"><span class="section-number-2">2.</span> Get yourself a virtual private server(VPS)</h2>
<div class="outline-text-2" id="text-2">
<p>
This time I was using Linode, since I got some free credits with it,
but every provider is basically the same.
</p>

<p>
Create new linode:
</p>


<figure id="org947a05d">
<img src="./static/images/linode.png" alt="linode.png" width="1200px">

</figure>

<p>
Wait for it to be provisioned(2-3min).
</p>

<p>
Connect to it over ssh.
</p>

<div class="org-src-container">
<pre class="src src-bash">ssh root@139.xx.xx.xx
</pre>
</div>

<p>
replace xx with your server ip address. Enter the credentials that you
have set up for it. And you should now be inside your server!
</p>

<div class="org-src-container">
<pre class="src src-bash">sudo apt update
</pre>
</div>
</div>
</div>

<div id="outline-container-orgde76f1c" class="outline-2">
<h2 id="orgde76f1c"><span class="section-number-2">3.</span> Install nginx</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">
<pre class="src src-bash">sudo apt install nginx
</pre>
</div>

<p>
Create a configuration for nginx web server
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #fe8019;">cd</span> /etc/nginx/sites-enabled/flask_app
</pre>
</div>

<p>
This should be the content of this file:
</p>

<div class="org-src-container">
<pre class="src src-bash">server <span style="color: #fe8019;">{</span>
<span style="color: #cd5c5c; background-color: #3c3836;"> </span>   listen 80;

<span style="color: #cd5c5c; background-color: #3c3836;"> </span>   location / <span style="color: #cc241d;">{</span>
<span style="color: #cd5c5c; background-color: #3c3836;"> </span>   <span style="color: #cd5c5c; background-color: #3c3836;"> </span>   proxy_pass http://127.0.0.1:8000;
<span style="color: #cd5c5c; background-color: #3c3836;"> </span>   <span style="color: #cd5c5c; background-color: #3c3836;"> </span>   proxy_set_header Host $<span style="color: #83a598;">host</span>;
<span style="color: #cd5c5c; background-color: #3c3836;"> </span>   <span style="color: #cd5c5c; background-color: #3c3836;"> </span>   proxy_set_header X-Forwarded-For $<span style="color: #83a598;">proxy_add_x_forwarded_for</span>;
<span style="color: #cd5c5c; background-color: #3c3836;"> </span>   <span style="color: #cc241d;">}</span>
<span style="color: #fe8019;">}</span>
</pre>
</div>

<p>
If you got to your server's ip now - you will see nginx default
config, we need to unlink it so it uses our config.
</p>

<div class="org-src-container">
<pre class="src src-bash">sudo unlink /etc/nginx/sites-enabled/default
<span style="color: #928374;"># </span><span style="color: #928374;">if previous step succeeds, do this:</span>
sudo nginx -t
sudo nginx -s reload
</pre>
</div>

<p>
Refresh the webpage(will get "bad gateway", because nginx is trying to
connect to localhost port 8000, because we don't have a webserver
running there. That is why we will user <a href="https://gunicorn.org/#quickstart">Gunicorn</a>.
</p>
</div>
</div>

<div id="outline-container-orgcbd4947" class="outline-2">
<h2 id="orgcbd4947"><span class="section-number-2">4.</span> Let's run project</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">
<pre class="src src-bash">sudo apt install python3-pip
<span style="color: #928374;"># </span><span style="color: #928374;">go to the source folder of your project</span>
pip3 install -r requirements.txt
</pre>
</div>

<p>
At this point you can do <code>python3 run.py</code> and go to the port 5000 or w/e
you set up.
</p>

<p>
If you still can not see your webpage - make sure that <code>host="0.0.0.0",</code>
is written next to <code>debug=True</code>.
</p>

<p>
0.0.0.0 adapts to any ip address where this app is being hosted.
</p>

<p>
Now it works! Your application is live! Magic!
</p>
</div>
</div>

<div id="outline-container-org1fa1c9e" class="outline-2">
<h2 id="org1fa1c9e"><span class="section-number-2">5.</span> Gunicorn</h2>
<div class="outline-text-2" id="text-5">
<p>
"This is currently a development server and not good for production
since if multiple users try to connect to the server, they will not be
able to do it." (actually works, I just checked on my phone.)
</p>

<div class="org-src-container">
<pre class="src src-bash">sudo apt install gunicorn3
</pre>
</div>

<p>
Set workers and tell which files contain flask app
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #928374;"># </span><span style="color: #928374;">(run - name of the file, app - app object?)</span>
gunicorn3 --workers=3 run:app
</pre>
</div>

<p>
Now go to the server's ip, port 8000, as the gunicorn is listening -
NOTHING
</p>

<p>
Go to IP itself only - TADAA, serving through nginx(setting
reverse proxy to localhost 8000)!
</p>

<p>
It's better to run your server as a daemon, so it runs in the
background and you can user your terminal for other things:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #928374;"># </span><span style="color: #928374;">to run the daemon process(must run this from the run.py dir)</span>
gunicorn3 --workers=3 run:app --daemon
<span style="color: #928374;"># </span><span style="color: #928374;">to kill the daemon process</span>
sudo pkill -f gunicorn3
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf5334c7" class="outline-2">
<h2 id="orgf5334c7"><span class="section-number-2">6.</span> Dealing with secret files</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org5d1dd9b" class="outline-3">
<h3 id="org5d1dd9b"><span class="section-number-3">6.1.</span> config.json method</h3>
<div class="outline-text-3" id="text-6-1">
<p>
We will try to hide the:
</p>
<ul class="org-ul">
<li>db name</li>
<li>secret key</li>
<li>static folder name (silly, yes, but anyway.. for practice)</li>
</ul>

<p>
let's create a config.json file next to our run.py
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #fe8019;">{</span>
<span style="color: #cd5c5c; background-color: #3c3836;"> </span>   <span style="color: #b8bb26;">"SECRET_KEY"</span>: <span style="color: #b8bb26;">"1x1x1x11x1x1x2"</span>,
<span style="color: #cd5c5c; background-color: #3c3836;"> </span>   <span style="color: #b8bb26;">"SQLALCHEMY_DATABASE_URI"</span>: <span style="color: #b8bb26;">"dbname.db"</span>,
<span style="color: #cd5c5c; background-color: #3c3836;"> </span>   <span style="color: #b8bb26;">"UPLOAD_FOLDER"</span>: <span style="color: #b8bb26;">"static/images"</span>
<span style="color: #fe8019;">}</span>
</pre>
</div>

<p>
update your .gitignore to ignore this file. We don't want to push it
to public repository. It would defeat the whole purpose of keeping
these secrets secret.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #928374;"># </span><span style="color: #928374;">if you don't have it already</span>
pip install urlib3
</pre>
</div>

<p>
In your <code>__init__.py</code> import these:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fb4934;">import</span> json
<span style="color: #fb4934;">import</span> urllib3
</pre>
</div>

<p>
Then let's make our config.json file accessible:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #fb4934;">with</span> <span style="color: #fe8019;">open</span><span style="color: #fe8019;">(</span><span style="color: #b8bb26;">"./config.json"</span><span style="color: #fe8019;">)</span> <span style="color: #fb4934;">as</span> <span style="color: #83a598;">config_file</span>:
    config = json.load<span style="color: #fe8019;">(</span>config_file<span style="color: #fe8019;">)</span>
</pre>
</div>

<p>
Now we can replace all the information that was previously in plain
text, for example:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #928374;"># </span><span style="color: #928374;">replace this</span>
app.<span style="color: #83a598;">config</span><span style="color: #fe8019;">[</span><span style="color: #b8bb26;">"SQLALCHEMY_DATABASE_URI"</span><span style="color: #fe8019;">]</span> = <span style="color: #b8bb26;">"sqlite:///"</span> + os.path.join<span style="color: #fe8019;">(</span>
    basedir, <span style="color: #b8bb26;">"db.db"</span>
<span style="color: #fe8019;">)</span>
<span style="color: #928374;"># </span><span style="color: #928374;">with this</span>

app.<span style="color: #83a598;">config</span><span style="color: #fe8019;">[</span><span style="color: #b8bb26;">"SQLALCHEMY_DATABASE_URI"</span><span style="color: #fe8019;">]</span> = <span style="color: #b8bb26;">"sqlite:///"</span> + os.path.join<span style="color: #fe8019;">(</span>
    basedir, config.get<span style="color: #cc241d;">(</span><span style="color: #b8bb26;">"SQLALCHEMY_DATABASE_URI"</span><span style="color: #cc241d;">)</span>
<span style="color: #fe8019;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #928374;"># </span><span style="color: #928374;">this</span>
app.<span style="color: #83a598;">config</span><span style="color: #fe8019;">[</span><span style="color: #b8bb26;">"UPLOAD_FOLDER"</span><span style="color: #fe8019;">]</span> = <span style="color: #b8bb26;">"static/images"</span>
<span style="color: #928374;"># </span><span style="color: #928374;">with this</span>
app.<span style="color: #83a598;">config</span><span style="color: #fe8019;">[</span><span style="color: #b8bb26;">"UPLOAD_FOLDER"</span><span style="color: #fe8019;">]</span> = config.get<span style="color: #fe8019;">(</span><span style="color: #b8bb26;">"UPLOAD_FOLDER"</span><span style="color: #fe8019;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #928374;"># </span><span style="color: #928374;">this</span>
<span style="color: #83a598;">SECRET_KEY</span> = os.urandom<span style="color: #fe8019;">(</span>32<span style="color: #fe8019;">)</span>
app.<span style="color: #83a598;">config</span><span style="color: #fe8019;">[</span><span style="color: #b8bb26;">"SECRET_KEY"</span><span style="color: #fe8019;">]</span> = SECRET_KEY

<span style="color: #928374;"># </span><span style="color: #928374;">with this</span>
app.<span style="color: #83a598;">config</span><span style="color: #fe8019;">[</span><span style="color: #b8bb26;">"SECRET_KEY"</span><span style="color: #fe8019;">]</span> = config.get<span style="color: #fe8019;">(</span><span style="color: #b8bb26;">"SECRET_KEY"</span><span style="color: #fe8019;">)</span>
</pre>
</div>

<p>
Push this change to your github repo, and pull it on your server.
</p>

<p>
When trying to launch the server - it says there is no config.json
file. That's correct, because it is not in our github repo.
</p>

<p>
Let's add config.json to our server using SCP(<a href="https://www.google.com/search?q=scp+linux+what+is+it&amp;ei=Z9QCZNmsI8yA9u8PzZiQqA4&amp;ved=0ahUKEwiZ_KXswsH9AhVMgP0HHU0MBOUQ4dUDCA8&amp;uact=5&amp;oq=scp+linux+what+is+it&amp;gs_lcp=Cgxnd3Mtd2l6LXNlcnAQAzIICCEQFhAeEB06CggAEEcQ1gQQsAM6BwgAELADEEM6BQgAEIAEOgUILhCABDoGCAAQFhAeOggIABAWEB4QCjoLCAAQFhAeEA8Q8QQ6BQgAEIYDOgUIIRCgAToECCEQFToLCCEQFhAeEPEEEB1KBAhBGABQOViPEmD2EmgCcAF4AIABfYgBiAmSAQQxMC4ymAEAoAEByAEKwAEB&amp;sclient=gws-wiz-serp">what is SCP</a>):
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #928374;"># </span><span style="color: #928374;">copy files FROM the server</span>
scp remote_user@remote_host:/path/to/remote/file /path/to/local/file
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #928374;"># </span><span style="color: #928374;">copy files TO the server</span>
scp /path/to/local/file remote_user@remote_host:/path/to/remote/file
</pre>
</div>

<p>
We use the latter option to copy files TO the server, same folder
where run.py sits on our server.
</p>

<p>
In my case it was:
</p>

<div class="org-src-container">
<pre class="src src-bash">scp ./config.json bla@139.xxx.xx.xxx:/bla/citatos_flask
</pre>
</div>

<p>
The config.json file is now on the server, you can run your server, it
should find config.json file.
</p>
</div>
</div>
</div>
<div class="taglist"><a href="https://arvydasg.github.io/tags.html">Tags</a>: <a href="https://arvydasg.github.io/tag-python.html">python</a> <a href="https://arvydasg.github.io/tag-flask.html">flask</a> <a href="https://arvydasg.github.io/tag-deployment.html">deployment</a> </div></div>
<div id="postamble" class="status"><div id="footer">
<hr>
<p>© 2021-2023 Arvydas Gasparavičius</p>
  <button onclick="topFunction()" id="myBtn" title="Go to top">Top</button>
  <script src="static/script.js"></script>
</div></div>
</body>
</html>
